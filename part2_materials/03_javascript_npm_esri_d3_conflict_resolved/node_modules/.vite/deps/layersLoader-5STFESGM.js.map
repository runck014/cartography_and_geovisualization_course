{
  "version": 3,
  "sources": ["../../@arcgis/core/portal/support/layersLoader.js"],
  "sourcesContent": ["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.31/esri/copyright.txt for details.\n*/\nimport e from\"../../core/Error.js\";import{parse as t}from\"../../layers/support/arcgisLayerUrl.js\";import{fetchFeatureService as r}from\"../../layers/support/fetchService.js\";import{LayerLoadContext as a}from\"../../layers/support/LayerLoadContext.js\";import{populateGroupLayer as o}from\"../../layers/support/layersCreator.js\";import{layerLookupMap as n}from\"../../layers/support/lazyLayerLoader.js\";import s from\"../Portal.js\";import{createForItemRead as i}from\"./jsonContext.js\";import{getFirstLayerOrTable as l,preprocessFSItemData as c,populateSceneServiceItemData as u,getNumLayersAndTables as p,createSublayerData as y,instanceTypeToLayerType as f,getSublayersByLayerType as m,layerTypeToLayerModuleType as d}from\"./loadUtils.js\";import{hasTypeKeyword as w}from\"./portalItemUtils.js\";import{loadStyleRenderer as h}from\"../../renderers/support/styleUtils.js\";import{fetchArcGISServiceJSON as I}from\"../../support/requestPresets.js\";async function g(e,t){const r=e.instance.portalItem;if(r?.id)return await r.load(t),b(e),e.validateItem&&e.validateItem(r),L(e,t)}function b(t){const r=t.instance.portalItem;if(!r?.type||!t.supportedTypes.includes(r.type))throw new e(\"portal:invalid-layer-item-type\",\"Invalid layer item type '${type}', expected '${expectedType}'\",{type:r?.type,expectedType:t.supportedTypes.join(\", \")})}async function L(e,t){const r=e.instance,o=r.portalItem;if(!o)return;const{url:n,title:s}=o,l=i(o,\"portal-item\");if(\"group\"===r.type)return S(r,l,e);n&&\"media\"!==r.type&&r.read({url:n},l);const c=new a,u=await M(e,c,t);return u&&r.read(u,l),r.resourceReferences={portalItem:o,paths:l.readResourcePaths??[]},\"subtype-group\"!==r.type&&r.read({title:s},l),h(r,l)}async function S(t,r,a){const o=t.portalItem;if(!t.sourceIsPortalItem)return;const{title:n,type:s}=o;if(\"Group Layer\"===s){if(!w(o,\"Map\"))throw new e(\"portal:invalid-layer-item-typekeyword\",\"'Group Layer' item without 'Map' type keyword is not supported\");return T(t)}return t.read({title:n},r),v(t,a)}async function T(e){const t=e.portalItem,r=await t.fetchData(\"json\");if(!r)return;const a=i(t,\"web-map\");e.read(r,a),await o(e,r,{context:a}),e.resourceReferences={portalItem:t,paths:a.readResourcePaths??[]}}async function v(t,r){let o;const{portalItem:n}=t;if(!n)return;const s=n.type,i=r.layerModuleTypeMap;switch(s){case\"Feature Service\":case\"Feature Collection\":o=i.FeatureLayer;break;case\"Stream Service\":o=i.StreamLayer;break;case\"Scene Service\":o=i.SceneLayer;break;default:throw new e(\"portal:unsupported-item-type-as-group\",`The item type '${s}' is not supported as a 'IGroupLayer'`)}const y=new a;let[f,m]=await Promise.all([o(),M(r,y)]),d=()=>f;if(\"Feature Service\"===s){const e=l(m)?.customParameters;m=n.url?await c(m,n.url,y):{},d=await E(m,i)||d;const r=await k(n.url,{customParameters:e,loadContext:y});return await F(t,d,m,r)}return\"Scene Service\"===s&&n.url&&(m=await u(n,m,y)),p(m)>0?await F(t,d,m):await j(t,d)}async function j(e,t){const{portalItem:r}=e;if(!r?.url)return;const a=await I(r.url);a&&F(e,t,{layers:a.layers?.map(y),tables:a.tables?.map(y)})}async function F(e,t,r,a){let o=r.layers||[];const s=r.tables||[];if(\"Feature Collection\"===e.portalItem?.type?(o.forEach(((e,t)=>{e.id=t,\"Table\"===e?.layerDefinition?.type&&s.push(e)})),o=o.filter((e=>\"Table\"!==e?.layerDefinition?.type))):(o.reverse(),s.reverse()),o.forEach((o=>{const n=a?.(o);if(n||!a){const a=P(e,t(o),r,o,n);e.add(a)}})),s.length){const t=await n.FeatureLayer();s.forEach((o=>{const n=a?.(o);if(n||!a){const a=P(e,t,r,o,n);e.tables.add(a)}}))}}function P(e,t,r,a,o){const n=e.portalItem,i={portalItem:n.clone(),layerId:a.id};null!=a.url&&(i.url=a.url);const l=new t(i);if(\"sourceJSON\"in l&&(l.sourceJSON=o),\"subtype-group\"!==l.type&&\"catalog\"!==l.type&&(l.sublayerTitleMode=\"service-name\"),\"Feature Collection\"===n.type){const e={origin:\"portal-item\",portal:n.portal||s.getDefault()};l.read(a,e);const t=r.showLegend;null!=t&&l.read({showLegend:t},e)}return l}async function M(e,t,r){if(!1===e.supportsData)return;const a=e.instance,o=a.portalItem;if(!o)return;let n=null;try{n=await o.fetchData(\"json\",r)}catch(s){}if(D(a)){let e=null;const r=await x(o,n,t);if((n?.layers||n?.tables)&&r>0){if(null==a.layerId){const e=f(a.type),t=e?m(n,e)[0]:l(n);t&&(a.layerId=t.id)}e=C(n,a),\"OrientedImageryLayer\"===e?.layerType&&\"oriented-imagery\"===a.type&&a.supportedSourceTypes.add(\"Feature Layer\"),e&&null!=n.showLegend&&(e.showLegend=n.showLegend)}return r>1&&\"sublayerTitleMode\"in a&&\"service-name\"!==a.sublayerTitleMode&&(a.sublayerTitleMode=\"item-title-and-service-name\"),e}return n}async function x(e,r,a){if(r?.layers&&r?.tables)return p(r);const o=t(e.url);if(!o)return 1;const n=await a.fetchServiceMetadata(o.url.path,{customParameters:l(r)?.customParameters}).catch((()=>null));return(r?.layers?.length??n?.layers?.length??0)+(r?.tables?.length??n?.tables?.length??0)}function C(e,t){const{layerId:r}=t,a=e.layers?.find((e=>e.id===r))||e.tables?.find((e=>e.id===r));return a&&G(a,t)?a:null}function D(e){return\"stream\"!==e.type&&\"layerId\"in e}function G(e,t){const r=\"layerType\"in e&&e.layerType,{type:a}=t;return!(\"feature\"===a&&r&&\"ArcGISFeatureLayer\"!==e.layerType||\"catalog\"===a&&!r||\"oriented-imagery\"===a&&!r||\"subtype-group\"===a&&!r)}async function k(e,t){const{layersJSON:a}=await r(e,t);if(!a)return null;const o=[...a.layers,...a.tables];return e=>o.find((t=>t.id===e.id))}async function E(e,t){const{layers:r}=e;if(!r?.length)return;const a=new Set,o=[];for(const{layerType:i}of r){const e=i??\"ArcGISFeatureLayer\";if(a.has(e))continue;a.add(e);const r=t[d(e)];o.push(r())}const n=await Promise.all(o),s=new Map;return Array.from(a).forEach(((e,t)=>{s.set(e,n[t])})),({layerType:e})=>{const t=e??\"ArcGISFeatureLayer\";return s.get(t)}}export{g as load};\n"],
  "mappings": "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",
  "names": ["e", "t", "b", "o", "n", "s", "l", "c", "u", "a", "v", "i", "d", "r", "_a"]
}
