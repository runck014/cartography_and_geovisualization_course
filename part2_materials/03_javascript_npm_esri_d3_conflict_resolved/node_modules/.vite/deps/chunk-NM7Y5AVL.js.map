{
  "version": 3,
  "sources": ["../../@arcgis/core/layers/support/rasterDatasets/EphemeralBlockCache.js", "../../@arcgis/core/layers/support/rasterDatasets/RawBlockCache.js"],
  "sourcesContent": ["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.31/esri/copyright.txt for details.\n*/\nclass t{constructor(t=15e3,e=5e3){this._timer=null,this._cachedBlocks=new Map,this._size=-1,this._duration=t,this._interval=Math.min(t,e)}decreaseRefCount(t,e){const s=t+\"/\"+e,r=this._cachedBlocks;if(r.has(s)){const t=r.get(s);return t.refCount--,t.refCount<=0&&(r.delete(s),t.controller&&t.controller.abort()),t.refCount}return 0}getBlock(t,e){const s=t+\"/\"+e,r=this._cachedBlocks;if(r.has(s)){const t=r.get(s);return t.ts=Date.now(),t.refCount++,r.delete(s),r.set(s,t),t.block}return null}putBlock(t,e,s,r){const i=this._cachedBlocks,c=t+\"/\"+e;if(i.has(c)){const t=i.get(c);t.ts=Date.now(),t.refCount++}else i.set(c,{block:s,ts:Date.now(),refCount:1,controller:r});this._trim(),this._updateTimer()}deleteBlock(t,e){const s=this._cachedBlocks,r=t+\"/\"+e;s.has(r)&&s.delete(r)}updateMaxSize(t){this._size=t,this._trim()}empty(){this._cachedBlocks.clear(),this._clearTimer()}getCurrentSize(){return this._cachedBlocks.size}_updateTimer(){if(null!=this._timer)return;const t=this._cachedBlocks;this._timer=setInterval((()=>{const e=Array.from(t),s=Date.now();for(let r=0;r<e.length&&e[r][1].ts<=s-this._duration;r++)t.delete(e[r][0]);0===t.size&&this._clearTimer()}),this._interval)}_trim(){const t=this._cachedBlocks;if(-1===this._size||this._size>=t.size)return;const e=Array.from(t);for(let s=0;s<e.length-this._size;s++)t.delete(e[s][0])}_clearTimer(){null!=this._timer&&(clearInterval(this._timer),this._timer=null)}}export{t as default};\n", "/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.31/esri/copyright.txt for details.\n*/\nimport\"../../../geometry.js\";import e from\"./EphemeralBlockCache.js\";import{projectExtent as t,projectResolution as n,snapPyramid as o}from\"../rasterFunctions/rasterProjectionHelper.js\";import l from\"../../../geometry/Point.js\";const r=new Map,c=new e;function i(e,t){return null==t?e:`${e}?sliceId=${t}`}function u(e,t){const n={extent:null,rasterInfo:t,cache:new Map},o=r.get(e);return o?(o.push(n),o.length-1):(r.set(e,[n]),0)}function a(e,t){const n=r.get(e);n&&(n[t]=null,n.some((e=>null!=e))||r.delete(e))}function f(e){r.delete(e)}function s(e,t,n){const o=r.get(e);if(!o)return null==t?c.decreaseRefCount(e,n):0;if(null==t||null==o[t])return c.decreaseRefCount(e,n);const l=o[t]?.cache,i=l?.get(n);if(l&&i){if(i.refCount--,0===i.refCount){l.delete(n);for(let e=0;e<o.length;e++)o[e]?.cache.delete(n);i.controller&&i.controller.abort()}return i.refCount}return 0}function m(e,t,n){const o=r.get(e);if(!o)return null==t?c.getBlock(e,n):null;if(null==t||null==o[t]){for(let e=0;e<o.length;e++){const t=o[e]?.cache.get(n);if(t)return t.refCount++,t.block}return c.getBlock(e,n)}const l=o[t]?.cache.get(n);if(l)return l.refCount++,l.block;for(let r=0;r<o.length;r++){if(r===t||!o[r])continue;const e=o[r]?.cache,l=e?.get(n);if(e&&l)return l.refCount++,e.set(n,l),l.block}return null}function x(e,t,n,o,l=null){const i=r.get(e);if(!i)return void(null==t&&c.putBlock(e,n,o,l));if(null==t||null==i[t])return void c.putBlock(e,n,o,l);const u={refCount:1,block:o,isResolved:!1,isRejected:!1,controller:l};o.then((()=>u.isResolved=!0)).catch((()=>u.isRejected=!0)),i[t]?.cache.set(n,u)}function h(e,t,n){const o=r.get(e);o?null!=t&&null!=o[t]?o[t]?.cache.delete(n):c.deleteBlock(e,n):null==t&&c.deleteBlock(e,n)}function d(e,t){const n=r.get(e);return n?n[t]??null:null}function g(e,r,c,i,u,a,f=null){const s=d(e,r);if(!s)return;const m=s.extent,{cache:x,rasterInfo:h}=s;if(m&&m.xmin===c.xmin&&m.xmax===c.xmax&&m.ymin===c.ymin&&m.ymax===c.ymax)return;i=i??0;const g=c.clone().normalize(),{spatialReference:y,transform:p}=h,k=new Set;for(let d=0;d<g.length;d++){const e=g[d];if(e.xmax-e.xmin<=i||e.ymax-e.ymin<=i)continue;let r=t(e,y,f);null!=p&&(r=p.inverseTransform(r));const c=new l({x:i,y:i,spatialReference:e.spatialReference});if(null==u&&!(u=n(c,y,e,f)))return;const{pyramidLevel:s,pyramidResolution:m,excessiveReading:x}=o(u,h,a||\"closest\");if(x)return;const{storageInfo:M}=h,{origin:R}=M,C={x:Math.max(0,Math.floor((r.xmin-R.x)/m.x)),y:Math.max(0,Math.floor((R.y-r.ymax)/m.y))},B=Math.ceil((r.xmax-r.xmin)/m.x-.1),j=Math.ceil((r.ymax-r.ymin)/m.y-.1),v=s>0?M.pyramidBlockWidth:M.blockWidth,b=s>0?M.pyramidBlockHeight:M.blockHeight,w=1,$=Math.max(0,Math.floor(C.x/v)-w),I=Math.max(0,Math.floor(C.y/b)-w),H=Math.floor((C.x+B-1)/v)+w,E=Math.floor((C.y+j-1)/b)+w;for(let t=I;t<=E;t++)for(let e=$;e<=H;e++)k.add(`${s}/${t}/${e}`)}x.forEach(((e,t)=>{if(!k.has(t)){const e=x.get(t);(null==e||e.isResolved||e.isRejected)&&x.delete(t)}})),s.extent={xmin:c.xmin,ymin:c.ymin,xmax:c.xmax,ymax:c.ymax}}export{s as decreaseRefCount,h as deleteBlock,f as deleteRaster,m as getBlock,i as getRasterId,x as putBlock,u as register,a as unregister,g as update};\n"],
  "mappings": "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",
  "names": ["t", "s", "r", "i", "c", "t", "e", "t", "i", "e", "r", "l", "u", "c", "a", "s", "m", "x", "h", "g", "d", "C", "j"]
}
