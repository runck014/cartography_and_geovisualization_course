/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import e from"../../Color.js";import"../../renderers/ClassBreaksRenderer.js";import"../../renderers/DictionaryRenderer.js";import"../../renderers/DotDensityRenderer.js";import"../../renderers/HeatmapRenderer.js";import r from"../../renderers/PieChartRenderer.js";import"../../renderers/Renderer.js";import"../../renderers/SimpleRenderer.js";import"../../renderers/UniqueValueRenderer.js";import"../../renderers/support/jsonUtils.js";import"../../core/Logger.js";import"../../symbols.js";import{isSome as a}from"../../core/arrayUtils.js";import{createUniqueColors as i}from"../../core/colorUtils.js";import t from"../../core/Error.js";import{toPt as n}from"../../core/screenUtils.js";import{fetchMessageBundle as s}from"../../intl/messages.js";import l from"../../layers/support/AggregateField.js";import o from"../../layers/support/ExpressionInfo.js";import u from"../../renderers/support/AttributeColorInfo.js";import{OthersCategory as p}from"../../renderers/support/OthersCategory.js";import m from"../heuristics/outline.js";import c from"../heuristics/sizeRange.js";import{createVisualVariables as d}from"./size.js";import{spliceVisualVariables as f,findSizeVVIndex as b,updateAuthoringInfoVisualVariable as h,findOutlineVVIndex as y,findScaleDependentSizeVVIndex as w,processRegenerateParams as g,getRendererToUpdate as v,getStyleType as z,hasOutlineVV as S,hasScaleDependentSizeVV as E,isSizeVV as j}from"./support/regenerateUtils.js";import{errorCallback as V,createSymbol as x,getSymbolOutlineFromScheme as C,verifyBasicFieldValidity as T,getBasemapInfo as $}from"./support/utils.js";import I from"../statistics/predominantCategories.js";import{getSumOfAttributesExpr as O}from"../statistics/support/utils.js";import{verifyBinningParams as k}from"../support/binningUtils.js";import{getFieldsList as q}from"../support/utils.js";import{LayerType as B,binningCapableLayerTypes as L,createLayerAdapter as P,getLayerTypeLabels as R,getLayerTypes as U}from"../support/adapters/support/layerUtils.js";import{cloneScheme as F,getSchemes as M}from"../symbology/pieChart.js";import{getCIMSymbolColor as N}from"../../symbols/support/cimSymbolUtils.js";import _ from"../../symbols/SimpleLineSymbol.js";const A=[B.CSVLayer,B.FeatureLayer,B.GeoJSONLayer,B.OGCFeatureLayer,B.OrientedImageryLayer,B.StreamLayer,B.WFSLayer];async function D(e){if(!(e?.layer&&e.view&&e.attributes?.length))throw new t("pie-chart-renderer:missing-parameters","'layer', 'view' and 'attributes' parameters are required");if(e.attributes.length>10)throw new t("pie-chart-renderer:invalid-parameters","PieChart renderer does not support more than 10 attributes");e.forBinning&&k(e,"pie-chart-renderer");const r={...e,layer:e.layer,view:e.view,attributes:e.attributes};r.shape=r.shape||"pie",r.othersCategoryEnabled??=!0,r.includeSizeVariable=e.includeSizeVariable||!1;const a=e.forBinning?L:A,i=P(r.layer,a,e.forBinning);if(!i)throw new t("pie-chart-renderer:invalid-parameters","'layer' must be one of these types: "+R(a).join(", "));const n=null!=r.signal?{signal:r.signal}:null;await Promise.all([e.view.when(),i.load(n)]);const s=i.geometryType,l="polygon"===s,o="point"===s||"multipoint"===s||l;if(r.outlineOptimizationEnabled=!!l&&r.outlineOptimizationEnabled,r.sizeOptimizationEnabled=!!o&&r.sizeOptimizationEnabled,!o)throw new t("pie-chart-renderer:not-supported","PieChart renderer is only supported for point and polygon layers");const u=[],p=r.attributes;for(const t of p){const e=await q({field:t.field,valueExpression:t.valueExpression});u.push(...e)}const m=T(i,u.filter(Boolean),"pie-chart-renderer:invalid-parameters");if(m)throw m;return{...r,layer:i}}async function W(e){const r="regenerate-pie-chart-renderer";await g(e,r);const a=await v(e);if("pie-chart"!==z(a))throw new t(`${r}:invalid-parameters`,"Renderer is invalid");const{visualVariables:i}=a,{layer:n,forBinning:s,filter:l,view:o,signal:u}=e,p=S(a),m=E(a),c=i?.some(j),d=a.attributes.map((e=>({field:e.field,label:e.label,valueExpression:e.valueExpression,valueExpressionTitle:e.valueExpressionTitle}))),f=await D({layer:n,attributes:d,outlineOptimizationEnabled:p,sizeOptimizationEnabled:m,includeSizeVariable:c,forBinning:s,filter:l,view:o,signal:u});return{...e,creatorParameters:f,renderer:a}}async function G(e){let r=e.pieChartScheme,a=null,i=null;const t=await $(e.basemap,e.view);if(a=null!=t.basemapId?t.basemapId:null,i=null!=t.basemapTheme?t.basemapTheme:null,r)return{scheme:F(r),basemapId:a,basemapTheme:i};const n=M({numColors:e.attributes.length,geometryType:e.layer.geometryType,basemapTheme:i});return n&&(r=n.primaryScheme,a=n.basemapId,i=n.basemapTheme),{scheme:r,basemapId:a,basemapTheme:i}}async function H(e,r){const{valueExpression:a,sqlExpression:i,sqlWhere:t}=O(e.attributes),n=await s("esri/smartMapping/t9n/smartMapping");return d({layer:e.layer,basemap:e.basemap,valueExpression:a,sqlExpression:i,sqlWhere:t,sizeScheme:r,sizeOptimizationEnabled:e.sizeOptimizationEnabled,legendOptions:{title:n.sumOfCategories},view:e.view,signal:e.signal})}async function J(e){const[l,o]=await Promise.all([D(e),s("esri/smartMapping/t9n/smartMapping")]),d=await G(l),f=d?.scheme;if(!f)throw new t("pie-chart-renderer:insufficient-info","Unable to find pie-chart scheme");const{layer:b,includeSizeVariable:h,sizeOptimizationEnabled:y,outlineOptimizationEnabled:w,view:g,signal:v,filter:z}=l,S=f.sizeScheme,E=l.attributes,j=E.map((e=>e.field)).filter(a),[T,$,O,k]=await Promise.all([j.length>1?I({layer:b,fields:j,view:g,signal:v,filter:z}):null,h?H(l,S):null,!h&&y?c({layer:b,view:g,signal:v,filter:z}).catch(V):null,w?m({layer:b,view:g,signal:v,filter:z}).catch(V):null]),q=T?.predominantCategoryInfos?{uniqueValueInfos:T.predominantCategoryInfos}:{uniqueValueInfos:j.map((e=>({value:e,count:0})))},B=i(f.colors,E.length),L=E.map(((e,r)=>new u({field:e.field,valueExpression:e.valueExpression,label:e.label,valueExpressionTitle:e.valueExpressionTitle,color:B[r]}))),P=b.geometryType,R=null!=S&&"background"in S&&S.background,U=new r({attributes:L,othersCategory:new p({label:o.other,color:l.othersCategoryEnabled?f.colorForOthersCategory:null,threshold:.04}),holePercentage:"donut"===l.shape?.45:0,backgroundFillSymbol:R?x(P,{type:"2d",color:R.color,outline:C(R,P,k?.opacity)}):null,size:n(f.size),outline:new _(C(f,"point",k?.opacity)),legendOptions:l.legendOptions});if($&&(K($,y,P),U.authoringInfo=$.authoringInfo.clone(),U.visualVariables=$.visualVariables?.map((e=>e.clone()))),k?.visualVariables?.length){const e=k.visualVariables.map((e=>e.clone())).filter((e=>"color"!==e.type&&"rotation"!==e.type));U.visualVariables?U.visualVariables.push(...e):U.visualVariables=e}return O?.minSize&&(Q(O,P),U.visualVariables?U.visualVariables.push(O.minSize):U.visualVariables=[O.minSize]),{renderer:U,pieChartScheme:F(f),size:$,basemapId:d.basemapId,basemapTheme:d.basemapTheme,statistics:q}}async function Z(e){const{creatorParameters:r,view:a,signal:i,filter:t,renderer:n}=await W(e),{layer:s,outlineOptimizationEnabled:l,includeSizeVariable:o,sizeOptimizationEnabled:u}=r,p=await G(r),d=p?.scheme?.sizeScheme,[g,v,z]=await Promise.all([l?m({layer:s,view:a,signal:i,filter:t}).catch(V):null,o?H(r,d):null,!o&&u?c({layer:s,view:a,signal:i,filter:t}).catch(V):null]),S=s.geometryType;if(v&&(K(v,u,S),f(n,v?.visualVariables,b),h(n,v?.authoringInfo,"size")),g?.visualVariables?.length){const e=g.visualVariables.map((e=>e.clone())).filter((e=>"color"!==e.type&&"rotation"!==e.type));f(n,e,y)}return z?.minSize&&(Q(z,S),f(n,z?.minSize,w)),{renderer:n}}function K(e,r,a){r||e.visualVariables.forEach((e=>{"number"==typeof e.minSize&&"number"==typeof e.maxSize&&(e.minSize*=2.5,e.maxSize*=1.8)})),r&&"point"===a&&e.visualVariables.forEach((e=>{e?.minSize&&"object"==typeof e.minSize&&e.minSize?.stops?.forEach((e=>{e.size*=1.8}))}))}function Q(e,r){"point"===r&&e.minSize.stops?.forEach((e=>{e.size*=2.5})),"polygon"===r&&e.minSize.stops?.forEach((e=>{e.size*=1.8}))}const X=new Set(["unique-value","class-breaks"]),Y=new e("#aaaaaa"),ee=new e("#5c5c5c"),re=[new e("#e60049"),new e("#0bb4ff"),new e("#50e991"),new e("#e6d800"),new e("#9b19f5"),new e("#ffa300"),new e("#dc0ab4"),new e("#b3d4ff"),new e("#00bfa0"),new e("#f0cccc")];async function ae(e){if(!e||!e.layer)throw new t("pie-chart-cluster-renderer:missing-parameters","'layer' parameter is required");const r={...e};r.shape=r.shape||"pie",r.defaultSymbolEnabled??=!0;const a=e.layer;if(!U(A).includes(a.type))throw new t("pie-chart-cluster-renderer:invalid-parameters","'layer' must be one of these types: "+R(A).join(", "));const i=null!=r.signal?{signal:r.signal}:null;await a.load(i);if(!("point"===a.geometryType))throw new t("pie-chart-cluster-renderer:invalid-parameters","Cluster renderers are only supported for point layers");const{renderer:n}=a;if(!n)throw new t("pie-chart-cluster-renderer:invalid-parameters","input layer does not have a renderer.");if(!X.has(n.type))throw new t("pie-chart-cluster-renderer:invalid-parameters",`Cannot create a pie chart renderer for clusters based on a ${n.type} renderer.`);if("valueExpression"in n&&n.valueExpression)throw new t("pie-chart-cluster-renderer:invalid-parameters","Cannot create a pie chart renderer for clusters from a layer whose renderer contains a valueExpression.");if("unique-value"===n.type){if(n.field2)throw new t("pie-chart-cluster-renderer:invalid-parameters","Cannot create a pie chart renderer for clusters from a UniqueValueRenderer using more than one field.");if(null!=n.uniqueValueInfos&&n.uniqueValueInfos.length>10)throw new t("pie-chart-cluster-renderer:invalid-parameters","PieChart cluster renderer cannot be created from a UniqueValueRenderer with more than 10 unique value infos.")}if("class-breaks"===n.type){if(n.classBreakInfos.length<2)throw new t("pie-chart-cluster-renderer:invalid-parameters","Cannot create a pie chart renderer for clusters from a layer renderer with a continuous color or size gradient.");if(n.classBreakInfos.length>10)throw new t("pie-chart-cluster-renderer:invalid-parameters","PieChart cluster renderer can not be created from a ClassBreaksRenderer with more than 10 class break infos.");if("class-breaks-size"===n?.authoringInfo?.type)throw new t("pie-chart-cluster-renderer:invalid-parameters","PieChart cluster renderer can not be created from a ClassBreaksRenderer with breaks varied by size instead of color.")}return r}async function ie(e){const a=await ae(e),{layer:i,shape:t,defaultSymbolEnabled:n,legendOptions:l}=a,{renderer:o}=i,p=(await s("esri/smartMapping/t9n/smartMapping")).other;let m=[];"unique-value"===o?.type&&(m=te({renderer:o,defaultSymbolEnabled:n,defaultLabelBackup:p})),"class-breaks"===o?.type&&(m=ne({renderer:o,defaultSymbolEnabled:n,defaultLabelBackup:p}));const c=[],d=[];for(const r of m){const{field:e,color:a}=r;c.push(e),d.push(new u({color:a,field:e.name,label:e.alias}))}return{fields:c,renderer:new r({attributes:d,legendOptions:l,holePercentage:"donut"===t?.45:0,outline:null,size:9,othersCategory:null})}}function te(e){const{renderer:r,defaultSymbolEnabled:a,defaultLabelBackup:t}=e,{field:n,defaultSymbol:s,defaultLabel:u}=r,p=r.uniqueValueInfos??[],m=s&&a,c=m?9:10,d=i(re,c),f=(n?p.slice(0,c).map(((e,r)=>{const a=e.label,i=d[r];return{field:new l({name:se(e.value?.toString()),alias:a,onStatisticExpression:new o({title:`Field definition - ${a}`,expression:oe(n,e),returnType:"number"}),statisticType:"sum"}),color:le(e.symbol,i)}})):null)??[];if(m){const e="cluster_default",r=u||t;f.push({field:new l({name:se(e),alias:r,onStatisticExpression:new o({title:`Field definition - ${r}`,expression:ue(n,p),returnType:"number"}),statisticType:"sum"}),color:le(s,ee)})}return f}function ne(e){const{renderer:r,defaultSymbolEnabled:a,defaultLabelBackup:t}=e,{field:n,classBreakInfos:s,defaultSymbol:u,defaultLabel:p}=r,m=u&&a,c=m?9:10,d=i(re,c),f=s.slice(0,c).map(((e,r)=>{const a=e.label||`${e.minValue} - ${e.maxValue}`,i=d[r];return{field:new l({name:se(a),alias:a,onStatisticExpression:new o({title:`Field definition - ${a}`,expression:pe(n,e),returnType:"number"}),statisticType:"sum"}),color:le(e.symbol,i)}}));if(m){const e="cluster_default",r=p||t;f.push({field:new l({name:se(e),alias:r,onStatisticExpression:new o({title:`Field definition - ${r}`,expression:me(n,s),returnType:"number"}),statisticType:"sum"}),color:le(u,ee)})}return f}function se(e){return"SUM_"+(e+"").replaceAll(/[^a-zA-Z0-9_]/g,"_")}function le(e,r){if("simple-marker"===e?.type&&e.color)return e.color.clone();if("cim"===e?.type){const r=N(e);if(r)return r.clone()}return r?r.clone():Y.clone()}function oe(e,r){return`Number(Text($feature["${e}"]) == "${r.value+""}")`}function ue(e,r){return`Number(!(${r.map((r=>`(Text($feature["${e}"]) == "${r.value+""}")`)).join(" || ")}))`}function pe(e,r){return`Number($feature["${e}"] >= ${r.minValue} && $feature["${e}"] < ${r.maxValue})`}function me(e,r){return`Number(!(${r.map((r=>`($feature["${e}"] >= ${r.minValue} && $feature["${e}"] < ${r.maxValue})`)).join(" || ")}))`}export{J as createRenderer,ie as createRendererForClustering,Z as regenerateRenderer};
