/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import t from"../../core/Logger.js";import{animationDebugFlags as r}from"./animationDebugFlags.js";import{defaultCIMValues as e}from"./defaultCIMValues.js";import{AnimatedSymbolRepeatType as n,AnimatedSymbolEasingType as o}from"./enums.js";import{getExtent as i}from"./SDFHelper.js";import{getProcessParam as a,getValue as s,getSize as m}from"./utils.js";import{TimeOrigin as l}from"../../views/2d/engine/webgl/animations/instructions.js";function c(t,r,e){return{transform:b(t,r,e.transform),fromColor:P(t,r,e.fromColor),toColor:g(t,r,e.toColor),colorMix:I(t,r,e.colorMix),toOpacity:T(t,r,e.toOpacity),opacityMix:h(t,r,e.opacityMix),hasAnimations:e.hasAnimations||!!r.animations&&r.animations.length>0}}function f(t){return!r.forceStaticPath&&(r.forceAnimatedPath||t.hasAnimations)}function p(r,e,n){if("CIMCharacterMarker"===e.type)return t.getLogger("animationUtils").error("#handleMarker()","CIM character markers do not support animations"),n;const o=a(r,e,"OffsetX"),i=a(r,e,"OffsetY");if("CIMPictureMarker"===e.type)return{...n,transform:{type:"AnimatedTransform",relativeTranslation:!1,absoluteScale:!0,translation:D([o,i]),rotation:D(0),scale:D(a(r,e,"Size")),parent:n.transform}};const s=e.frame,m=s.ymax-s.ymin;return{...n,transform:{type:"AnimatedTransform",relativeTranslation:!1,absoluteScale:!1,translation:D([o,i]),rotation:D(0),scale:D({type:"Process",op:"Divide",left:a(r,e,"Size"),right:m}),parent:n.transform}}}function u(t,r){let e=0,n=0;const o="Absolute"!==t.anchorPointUnits;return t.anchorPoint&&(e=-t.anchorPoint.x,n=-t.anchorPoint.y),{...r,transform:{type:"AnimatedTransform",relativeTranslation:o,absoluteScale:!1,translation:D([e,n]),rotation:D(0),scale:D(1),parent:r.transform}}}function y(t,r){return"Absolute"===t.anchorPointUnits?r:u(t,r)}function C(t,r){return"Absolute"!==t.anchorPointUnits?r:u(t,r)}function M(t,r,e){return{...t,transform:{type:"AnimatedTransform",relativeTranslation:!1,absoluteScale:!1,translation:D([r,e]),rotation:D(0),scale:D(1),parent:t.transform}}}function S(t,r){const e=r?.5*-(r.xmin+r.xmax):0,n=r?.5*-(r.ymin+r.ymax):0;let o=0,a=0;if("x"in t&&"y"in t)o=t.x+e,a=t.y+n;else{const r=i(t);if(r){o=(r[0]+r[2])/2+e,a=(r[1]+r[3])/2+n}}return[o,a]}function A(t,r){switch(r.type){case"CIMPictureMarker":case"CIMVectorMarker":return a(t,r,"Rotation")}return 0}function d(t,r){switch(r.type){case"CIMPointSymbol":case"CIMVectorMarker":return[1,1,1,1];case"CIMSolidStroke":case"CIMSolidFill":return a(t,r,"Color");case"CIMPictureMarker":case"CIMPictureStroke":case"CIMPictureFill":return a(t,r,"TintColor")}return[1,1,1,1]}function b(t,r,e){return{type:"AnimatedTransform",relativeTranslation:!1,absoluteScale:!1,translation:O(t,r),rotation:v(t,r),scale:x(t,r),parent:e}}function P(t,r,e){return{type:"AnimatedColor",color:D(d(t,r)),opacity:D(1),parent:e}}function g(t,r,e){const{animations:n}=r;let o=d(t,r);const i=n?.filter((t=>"CIMSymbolAnimationColor"===t.type))[0];return i&&(o=a(t,i,"ToColor")),{type:"AnimatedColor",color:D(o),opacity:D(1),parent:e}}function I(t,r,e){const{animations:n}=r,o=n?.filter((t=>"CIMSymbolAnimationColor"===t.type))[0];return o?{type:"AnimatedColor",color:D([1,1,1,1]),opacity:{from:0,to:1,timing:k(t,o?.animatedSymbolProperties)},parent:[1,1,1,1]}:e}function T(t,r,e){const{animations:n}=r;let o=D(1);const i=n?.filter((t=>"CIMSymbolAnimationTransparency"===t.type))[0];if(i){o=D({type:"Process",op:"Transparency",value:a(t,i,"ToTransparency")})}return{type:"AnimatedColor",color:D([1,1,1,1]),opacity:o,parent:e}}function h(t,r,e){const{animations:n}=r,o=n?.filter((t=>"CIMSymbolAnimationTransparency"===t.type))[0];return o?{type:"AnimatedColor",color:D([1,1,1,1]),opacity:{from:0,to:1,timing:k(t,o?.animatedSymbolProperties)},parent:[1,1,1,1]}:e}function k(t,r){if(!r)return{duration:1,startTimeOffset:0,repeatDelay:0,timeOriginSelector:l.Local,repeatType:n.Loop,easing:o.Linear,playAnimation:1,reverseAnimation:0};const i=a(t,r,"Duration");let m;if(a(t,r,"RandomizeStartTime")){m={type:"Process",op:"Random",min:0,max:i,seed:a(t,r,"RandomizeStartSeed")}}else m=a(t,r,"StartTimeOffset");const c=a(t,r,"RepeatDelay"),f=a(t,r,"PlayAnimation"),p=a(t,r,"ReverseAnimation"),u=s(r.repeatType,e.CIMAnimatedSymbolProperties.repeattype);return{duration:i,startTimeOffset:m,repeatDelay:c,timeOriginSelector:u===n.None?l.Local:l.Global,repeatType:u,easing:s(r.easing,e.CIMAnimatedSymbolProperties.easing),playAnimation:f,reverseAnimation:p}}function x(t,r){const{animations:e}=r;if("CIMPictureMarker"!==r.type&&"CIMVectorMarker"!==r.type&&"CIMPointSymbol"!==r.type)return D(1);let n;n="CIMPictureMarker"===r.type||"CIMVectorMarker"===r.type?a(t,r,"Size"):m(r)||10;const o=e?.filter((t=>"CIMSymbolAnimationScale"===t.type))[0];if(!o){const r=e?.filter((t=>"CIMSymbolAnimationSize"===t.type))[0];if(!r)return D(1);return{from:1,to:{type:"Process",op:"Divide",left:a(t,r,"ToSize"),right:n},timing:k(t,r.animatedSymbolProperties)}}return{from:1,to:a(t,o,"ScaleFactor"),timing:k(t,o.animatedSymbolProperties)}}function O(t,r){const{animations:e}=r,n=e?.filter((t=>"CIMSymbolAnimationOffset"===t.type))[0];if(!n)return D([0,0]);return{from:[0,0],to:[a(t,n,"OffsetX"),a(t,n,"OffsetY")],timing:k(t,n.animatedSymbolProperties)}}function v(t,r){const{animations:e}=r,n=A(t,r),o=e?.filter((t=>"CIMSymbolAnimationRotation"===t.type))[0];if(!o)return D(n);return{from:n,to:a(t,o,"ToRotation"),timing:k(t,o.animatedSymbolProperties)}}function D(t){return{from:t,to:t,timing:{duration:1,startTimeOffset:0,repeatDelay:0,timeOriginSelector:l.Local,repeatType:n.Loop,easing:o.Linear,playAnimation:1,reverseAnimation:0}}}function L(t){if(null==t)return!1;if("object"!=typeof t)return!1;if(t.animations&&Array.isArray(t.animations)&&t.animations.length>0)return!0;for(const r in t)if(L(t[r]))return!0;return!1}export{L as checkForAnimations,c as getAnimationParams,S as getFrameTranslation,D as getStaticParam,C as handleAbsoluteAnchor,u as handleAnchor,p as handleMarker,y as handleRelativeAnchor,f as shouldUseAnimatedPath,M as translate};
