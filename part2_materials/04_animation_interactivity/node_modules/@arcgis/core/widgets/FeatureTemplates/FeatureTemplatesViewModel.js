/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.32/esri/copyright.txt for details.
*/
import{_ as t}from"../../chunks/tslib.es6.js";import{createTask as e}from"../../core/asyncUtils.js";import s from"../../core/Evented.js";import{abortMaybe as l}from"../../core/maybe.js";import{throwIfAborted as o}from"../../core/promiseUtils.js";import{watch as r,when as i,syncAndInitial as a,sync as n}from"../../core/reactiveUtils.js";import{property as p}from"../../core/accessorSupport/decorators/property.js";import"../../core/has.js";import"../../core/Logger.js";import"../../core/RandomLCG.js";import{subclass as u}from"../../core/accessorSupport/decorators/subclass.js";import{UpdatingHandles as m}from"../../core/support/UpdatingHandles.js";import{getTemplatesForLayers as d}from"../../editing/templateUtils.js";import{getEffectiveLayerCapabilities as c,isSubtypeGroupLayer as h}from"../../layers/support/layerUtils.js";import{isTemplateItemGroup as y,mapItemsByTemplate as f,isTemplateGroupInfo as g,loadLayerWithTemplates as _,makeTemplateItemInfos as I,makeGroupItemInfos as F,nullGroupBy as b}from"./featureTemplatesUtils.js";import v from"./TemplateItem.js";import T from"./TemplateItemGroup.js";const j=({layer:t})=>({key:t,label:t.title??""}),B=({layer:t})=>({key:t.geometryType,label:t.geometryType??""});let w=class extends s.EventedAccessor{constructor(t){super(t),this._allItems=[],this._updatingHandles=new m,this._updateTask=null,this.disabled=!1,this.disabledItemFunction=null,this.filterFunction=null,this.selectedItem=null,this.templateInfos=null,this.view=null}initialize(){this._get("groupBy")||(this.groupBy="layer"),this.addHandles([r((()=>[this.templateInfos,this.layers]),(([t],e)=>{t&&t===e?.at(0)||(this._updateTask=l(this._updateTask),t?this._updateAllItems(t):this._getTemplatesAndUpdateAllItems())}),a),r((()=>this._groupByFunction),(()=>{null==this.templateInfos&&(this._updateTask=l(this._updateTask),this._getTemplatesAndUpdateAllItems())}),n),r((()=>this.filterFunction),(t=>{for(const e of this._allItems)y(e)&&(e.filterFunction=t)}),n)])}set groupBy(t){if(this._set("groupBy",t),"function"!=typeof t)switch(t){case"layer":this._groupByFunction=j;break;case"geometry":this._groupByFunction=B;break;default:this._groupByFunction=null}else this._groupByFunction=e=>this._ensureGroupByObject(t(e))}get layers(){return this._get("layers")}set layers(t){const e="layers";if(this.removeHandles(e),t){const s=()=>this.notifyChange("state");this.addHandles(t.map((t=>i((()=>t.loadStatus),s))),e)}this._set("layers",t)}get state(){return this.updating?"loading":0!==this.layers.length||this.templateInfos?.length?"ready":"disabled"}get numberOfFeatureTemplates(){return this._allItems.reduce(((t,e)=>y(e)?t+e.allItems.length:t+1),0)}get items(){const{filterFunction:t}=this;return null==t?this._allItems:this._allItems.filter((e=>y(e)?e.items.length>0:t(e)))}get updating(){return this._updatingHandles.updating}refresh(){this.notifyChange("filterFunction");for(const t of this._allItems)y(t)&&t.reapplyFilter()}select(t,{emit:e=!0}={}){const s=this.selectedItem,l=t?.clone()||null;this._set("selectedItem",l),e&&this.emit("select",{item:l,oldItem:s,template:l?.template??null})}_createItem(t,e){return new v({disabledFunction:this.disabledItemFunction,layer:e,template:t})}_ensureGroupByObject(t){return"string"==typeof t?{key:t,label:t}:t}_updateAllItems(t){const e=this._allItems;if(0===t.length)return k(e),void(this._allItems=[]);const[s,l]=f(e),o=t=>{const e=s.get(t.template);return e?(s.delete(t.template),e):this._createItem(t.template,t.layer)},{filterFunction:r}=this,i=t.map((t=>g(t)?new T({filterFunction:r,label:t.label,allItems:t.templateInfos.map((t=>o(t)))}):o(t)));for(const a of[...s.values(),...l])a.destroy();this._allItems=i}async _getTemplatesFromLayers(t){const e=[],s={signal:t};await Promise.all(this.layers.map((async l=>{await _(l,s),o(t);const r=c(l)?.operations;r?.supportsEditing&&r?.supportsAdd&&(h(l)?e.push(...l.sublayers):e.push(l))})));const l=await d(e,this.view,t);o(t);const r=I(l),i=this._groupByFunction;if(null==i)return r;const a=F(r,i);return 1===a.length&&a[0].label===b.label?a[0].templateInfos:a}async _getTemplatesAndUpdateAllItems(){if(0===this.layers.length)return;const t=e((async t=>{const e=await this._getTemplatesFromLayers(t);o(t),this._updateAllItems(e)}));this._updateTask=t,this._updatingHandles.addPromise(t.promise)}};function k(t){for(const e of t){if(y(e))for(const t of e.items)t.destroy();e.destroy()}}t([p()],w.prototype,"_allItems",void 0),t([p()],w.prototype,"_groupByFunction",void 0),t([p()],w.prototype,"_updatingHandles",void 0),t([p()],w.prototype,"disabled",void 0),t([p()],w.prototype,"disabledItemFunction",void 0),t([p({value:null})],w.prototype,"filterFunction",void 0),t([p()],w.prototype,"groupBy",null),t([p({value:[]})],w.prototype,"layers",null),t([p()],w.prototype,"state",null),t([p({readOnly:!0})],w.prototype,"numberOfFeatureTemplates",null),t([p({readOnly:!0})],w.prototype,"items",null),t([p({readOnly:!0})],w.prototype,"selectedItem",void 0),t([p()],w.prototype,"templateInfos",void 0),t([p()],w.prototype,"updating",null),t([p()],w.prototype,"view",void 0),w=t([u("esri.widgets.FeatureTemplates.FeatureTemplatesViewModel")],w);const A=w;export{A as default};
