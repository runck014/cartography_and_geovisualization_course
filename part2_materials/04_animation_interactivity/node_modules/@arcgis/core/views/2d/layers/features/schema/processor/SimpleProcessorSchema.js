/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.32/esri/copyright.txt for details.
*/
import{pt2px as e}from"../../../../../../core/screenUtils.js";import r from"../../../../../../layers/support/OrderByInfo.js";import{TechniqueType as t}from"../../../../engine/webgl/shaderGraph/techniques/TechniqueType.js";import{createLabelMatcherSchema as s}from"./LabelMatcherSchema.js";import{createMatcherSchema as i}from"./MatcherSchema.js";import{createStorageSchema as n,createTrackStorageSchema as a}from"./StorageSchema.js";import{createVisualVariableUniforms as o}from"./VisualVariablesSchema.js";async function l(e,r){const t=r.renderer,n=o(t);return{symbology:await i(e,t),labels:await s(e,r,n)}}async function u(e,r,t,s){const i=t.featureReduction;if(i)switch(i.type){case"binning":return p(i,e,r,t,s);case"cluster":return y(i,e,r,t,s)}if(t.trackInfo?.enabled)return b(t.trackInfo,e,r,t,s);const a=m(t.orderBy,t.renderer,t.objectIdField),o=n(t.renderer,r.filters),u=await l(e,t),c=g(u.symbology);return{storage:o,mesh:{properties:{sortKey:a,timeZone:r.timeZone,returnMeshObjectId:c,displayRefreshVersion:s,currentUser:r.currentUser},strategy:{type:"feature"},factory:u},expressionProperties:{timeExtent:r.timeExtent?.toJSON()}}}function c(e,r){return e.fields.map((e=>({...e.toJSON(),type:f(e,r)})))}function f(e,r){const{onStatisticExpression:t,onStatisticField:s,statisticType:i}=e;switch(i){case"min":case"max":case"avg":case"avg_angle":case"sum":case"count":return"esriFieldTypeDouble";case"mode":{if(t){const{returnType:e}=t;return e?"string"===e?"esriFieldTypeString":"esriFieldTypeDouble":"esriFieldTypeString"}const e=r.find((e=>e.name===s));return e?e.type:"esriFieldTypeString"}}}async function p(r,t,a,l,u){const f=c(r,l.fields),p=r.renderer,y=await i(t,p),b=n(p,[null,null]),m=o(p),d=await s(t,{geometryType:"polygon",labelingInfo:r.labelingInfo,labelsVisible:r.labelsVisible},m),v=g(y),h="geohash"===r.binType?{type:"geohash",fixBinLevel:r.fixedBinLevel??3}:{type:"grid",size:e(r.size),fixedBinLevel:r.fixedBinLevel};return{storage:b,mesh:{properties:{sortKey:null,timeZone:a.timeZone,returnMeshObjectId:v,displayRefreshVersion:u,currentUser:a.currentUser},strategy:{type:"binning",fields:f,index:h,featureFilter:a.filters[0]},factory:{labels:d,symbology:y}},expressionProperties:{timeExtent:a.timeExtent?.toJSON()}}}async function y(r,t,a,l,u){const f=c(r,l.fields),p={type:"cluster",feature:await i(t,r.effectiveFeatureRenderer),cluster:await i(t,r.effectiveClusterRenderer)},y=o(r.effectiveFeatureRenderer),b={type:"cluster",feature:await s(t,l,y),cluster:await s(t,{geometryType:"point",labelingInfo:r.labelingInfo,labelsVisible:r.labelsVisible},y)},m=n(r.effectiveFeatureRenderer,[null,null]),d=g(p);return{storage:m,mesh:{properties:{sortKey:null,timeZone:a.timeZone,displayRefreshVersion:u,returnMeshObjectId:d,currentUser:a.currentUser},strategy:{type:"cluster",fields:f,featureFilter:a.filters[0],clusterRadius:e(r.clusterRadius/2)},factory:{labels:b,symbology:p}},expressionProperties:{timeExtent:a.timeExtent?.toJSON()}}}async function b(e,r,t,n,l){const u=c(e,n.fields),f={type:"track",previousObservation:await i(r,e.previousObservations.renderer),latestObservation:await i(r,e.latestObservations.renderer),trackLine:await i(r,e.trackLines.renderer)},p={type:"track",previousObservation:await s(r,{geometryType:n.geometryType,labelingInfo:e.previousObservations.labelingInfo,labelsVisible:e.previousObservations.labelsVisible},o(e.previousObservations.renderer)),latestObservation:await s(r,{geometryType:n.geometryType,labelingInfo:e.latestObservations.labelingInfo,labelsVisible:e.latestObservations.labelsVisible},o(e.latestObservations.renderer)),trackLine:await s(r,{geometryType:"polyline",labelingInfo:e.trackLines.labelingInfo,labelsVisible:e.trackLines.labelsVisible},o(e.trackLines.renderer))},y=a(e,[null,null]),b=g(f);return{storage:y,mesh:{properties:{sortKey:null,timeZone:t.timeZone,returnMeshObjectId:b,displayRefreshVersion:l,currentUser:t.currentUser},strategy:{type:"track",featureFilter:t.filters[0],fields:u,maxDisplayDuration:e.maxDisplayDuration?.toMilliseconds()??0,maxDisplayObservationsPerTrack:e.maxDisplayObservationsPerTrack,showLatestObservation:e.latestObservations.visible,showPreviousObservations:e.previousObservations.visible,showTrackLine:e.trackLines.visible,timeField:e.timeField},factory:{labels:p,symbology:f}},expressionProperties:{timeExtent:t.timeExtent?.toJSON()}}}function m(e,t,s){const i=null!=t&&"unique-value"===t.type&&t.orderByClassesEnabled;if("default"!==e||i||(e=[new r({field:s,order:"descending"})]),"default"!==e&&e?.length){e.length;const r=e[0],t="ascending"===r.order?"asc":"desc";return r.field?{field:r.field,order:t}:r.valueExpression?{expression:r.valueExpression,order:t}:null}if(i){return{byRenderer:!0,order:"asc"}}return null}function d(e){return e.techniqueType===t.AnimatedMarker}function g(e){if("simple"===e.type&&e.meshes.some(d))return!0;if("interval"===e.type){if(e.intervals.some((e=>e.meshes.some(d))))return!0;if(e.backgroundFill.some(d))return!0}if("map"===e.type){if(e.map.some((e=>e.symbol.some(d))))return!0;if(e.backgroundFill.some(d))return!0}return!1}export{u as createSimpleProcessorSchema,c as getAggregateFields};
